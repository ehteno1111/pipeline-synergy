name: âš¡ï¸ Quantum IaC Security Scan

on:
  push:
  pull_request:

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  quantum-scan:
    name: âš¡ tfsec â€¢ next-gen Terraform security
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: ğŸŒŒ Detect Terraform root
        id: detect
        shell: bash
        run: |
          if [ -d "infra/terraform" ]; then
            echo "TF_ROOT=infra/terraform" >> "$GITHUB_ENV"
          else
            echo "TF_ROOT=." >> "$GITHUB_ENV"
          fi

      - name: ğŸ“ Show tree
        run: |
          echo "TF_ROOT=${TF_ROOT}"
          ls -la $TF_ROOT

      - name: ğŸš€ Terraform init (no backend)
        run: terraform init -backend=false
        working-directory: ${{ env.TF_ROOT }}

      - name: ğŸ›°ï¸ tfsec SARIF
        uses: aquasecurity/tfsec-sarif-action@v0.1.4
        with:
          working_directory: ${{ env.TF_ROOT }}
          sarif_file: tfsec.sarif
          tfsec_args: --exclude-downloaded-modules

      - name: ğŸ“¡ Upload SARIF to Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: tfsec.sarif
